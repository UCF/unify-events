{% extends 'events/frontend/base.html' %}
{% load widgets %}
{% load widget_tweaks %}
{% load core_tags %}

{% block content_title %}
<h1 class="col-md-12">
    <a href="{{ request.build_absolute_uri }}">
    {% if not query %}
    Search
    {% else %}
    Search Results For: <span class="alt"><em>&ldquo;{{ query }}&rdquo;</em></span>
    {% endif %}
    </a>
</h1>
{% endblock %}

{% block content_body %}
<div class="row">
    <div class="col-md-12" id="search">
        {% block search_nav %}

        {% if request.GET.q %}
            {% with 'q='|add:request.GET.q as params %}
            {% include_esi_template 'esi/search-nav.html' params %}
            {% endwith %}
        {% else %}
            {% include_esi_template 'esi/search-nav.html' 'q=' %}
        {% endif %}

        <form method="GET" action=".">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <label class="sr-only" for="{{ form.q.auto_id }}">{{ form.q.label }}</label>
                        {{ form.q|add_class:"search-query form-control" }}

                        <div class="input-group-btn">
                            <button tabindex="-1" class="btn btn-primary" type="submit">Search</button>
                            <button tabindex="-1" data-toggle="dropdown" class="btn btn-primary dropdown-toggle" type="button">
                                <span class="caret"></span>
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-form dropdown-menu-right" id="{{ form.models.auto_id }}" role="menu">
                                {% for model in form.models %}
                                <li>{{ model }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        {% endblock %}

        <div class="row">
            <div class="col-md-8 sidebarfix page-content">
                {% if query %}
                    {% with page.object_list as results %}
                        {% regroup results|dictsort:"verbose_name_plural" by verbose_name_plural as grouped_objects %}
                        {% for model in grouped_objects %}
                            {% if model.grouper != 'Events' %}
                                <h2>{{ model.grouper }}</h2>
                                {% for result in model.list %}
                                <p>
                                    <a href="{{ result.object.get_absolute_url }}">{{ result.object.title }}</a>
                                </p>
                                {% endfor %}
                            {% else %}
                                <h2>{{ model.grouper }}</h2>
                                <ul class="event-list">
                                {% with listing_templ="events/frontend/event-listing/listing.html" event_instances=model.list %}
                                {% include listing_templ %}
                                {% endwith %}
                                </ul>
                            {% endif %}
                            {% if not forloop.last %}<hr/>{% endif %}
                        {% empty %}
                            <p>No results found.</p>
                        {% endfor %}
                    {% endwith %}
                    {% pager paginator=paginator current_page=request.GET.page url=request.build_absolute_uri %}
                {% else %}
                    {# Show some example queries to run, maybe query syntax, something else? #}
                    Search for something!
                {% endif %}
            </div>
            <aside class="col-md-4 page-sidebar">
                <h3 class="alt h4">Browse All Categories:</h3>
                {% category_filters %}
            </aside>
        </div>
    </div>
</div>
{% endblock %}
