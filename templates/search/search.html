{% extends 'events/frontend/base.html' %}
{% load widgets %}
{% load widget_tweaks %}
{% load core_tags %}

{% block meta %}{% endblock %}

{% block content_title %}
<h1 class="col-md-12">
    <a href="{{ request.build_absolute_uri }}">
    {% if not query %}
    Search
    {% else %}
    Search Results For: <span class="alt"><em>&ldquo;{{ query }}&rdquo;</em></span>
    {% endif %}
    </a>
</h1>
{% endblock %}

{% block content_body %}
<div class="row">
    <div class="col-md-12" id="search">
        {% block search_nav %}

        {% if request.GET.q %}
            {% with 'q='|add:request.GET.q as params %}
            {% include_esi_template 'esi/search-nav.html' params %}
            {% endwith %}

            <form method="GET" action="." class="form-horizontal" role="form">
                <div class="form-group">
                    <label for="{{ form.models.auto_id }}" class="control-label col-md-auto">Filter Results by:</label>
                    <div class="col-md-auto">
                        {% for model in form.models %}
                        <div class="checkbox checkbox-inline">
                            {{ model }}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-auto">
                        <input type="hidden" name="q" id="id_q" value="{{ request.GET.q }}" /> 
                        <button type="submit" class="btn btn-default">Submit</button>
                    </div>
                </div>
            </form>
        {% else %}
            {% include_esi_template 'esi/search-nav.html' 'q=' %}
        {% endif %}

        {% endblock %}

        <div class="row">
            <div class="col-md-12 page-content">
                <p><em>{{ page.paginator.count }} result(s) found.</em></p>

                {% if query %}
                    {% with results=page.object_list %}
                        {% if results %}
                            <ul class="search-results-list">
                            {% for result in results %}
                                <li>
                                {% if result.model_name == 'calendar' %}
                                    <h3 class="search-object-title calendar-title">
                                        <a href="{{ result.object.get_absolute_url }}">
                                            <i class="fa fa-calendar"></i>{{ result.object.title }}
                                        </a>
                                    </h3>
                                    {% if result.description %}
                                    <span class="calendar-description">
                                        {{ result.description }}
                                    </span>
                                    {% endif %}
                                {% elif result.model_name == 'event' %}
                                    <h3 class="search-object-title event-title">
                                        <a href="{{ result.object.get_absolute_url }}">
                                            {{ result.object.title }}
                                        </a>
                                    </h3>
                                    <p class="description">
                                        {{ result.description|striptags|truncatewords:60 }}
                                    </p>
                                    <div class="result-meta">
                                        <div class="event-calendar">
                                            <i class="fa fa-calendar fa-fw"></i>
                                            <a href="{% url 'calendar' pk=result.object.calendar.pk slug=result.object.calendar.slug %}">{{ result.calendar }}</a>
                                        </div>
                                        <div class="event-category category-text {{ result.object.category.slug }}">
                                            <i class="fa fa-tag fa-fw"></i>
                                            <a href="{% url 'category' category_pk=result.object.category.pk category=result.object.category.slug %}">{{ result.category }}</a>
                                        </div>
                                        {% if result.object.tags|length > 0 %}
                                        <div class="event-tags">
                                            <i class="fa fa-tags fa-fw"></i>
                                            <ul>
                                            {% for tag in result.object.tags.all %}
                                                <li><a href="{% url 'tag' tag_pk=tag.pk tag=tag.slug %}">{{ tag }}</a></li>
                                            {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    {% endwith %}
                    {% pager paginator=paginator current_page=request.GET.page url=request.build_absolute_uri %}
                {% else %}
                    {# Show some example queries to run, maybe query syntax, something else? #}
                    <p>Search for something using the search bar.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
