{% load core_tags %}

{% comment %}
Try to use passed instance_start and instance_end value in context or request.GET
for each instance (which pass mapped start/end datetimes), if available.
Context values are passed in debug mode; GET params are passed when debug is turned off.

Default to the instance's start and end datetime.

Strings are parsed into datetimes with the 'parse_string' filter.
{% endcomment %}

{% with instance_start=instance_start.0|default:object.start instance_end=instance_end.0|default:object.end %}
    {% with instance_start=request.GET.instance_start|default:instance_start|parse_date instance_end=request.GET.instance_end|default:instance_end|parse_date %}
        <li class="event {% include_esi 'category' object.event.category.pk 'slug' %}{% if object.event.canceled %} canceled{% endif %}">
            <h3 class="event-title">
                <a class="summary" href="{% url 'event' pk=object.pk slug=object.slug %}">{{ object.event.get_title_canceled }}</a>
                {% if object.is_recurring %}
                <i class="fa fa-repeat"></i><span class="sr-only">(Recurring Event)</span>
                {% endif %}
            </h3>

            {% comment %}
            This template handles event instance information when a contextual 'start_date' constant is
            defined (i.e. on a calendar-based list view), and when one is not defined (i.e. on a tag/category-based
            list view.)  Some data, while still printed to the screen, is hidden via CSS.

            "Start date" phrasing logic:
            "[start-date] + [phrase]": if a 'start_date' constant is not defined
            "+ at [time]": if the start time is available, and if a 'start_date' constant is not defined
            "+ [time]": if the start time is available, and if a 'start_date' constant is defined
            "+ [empty]": if the start and end date are empty and identical; i.e. are imported events with no set start/end times
            "+ All Day": if the instance starts at "00:00" and ends at "23:59" (spans the entirety of the day)
            "+ until [time]": if the instance starts at "00:00" but does not span the entirety of the day
            "+ All Day": fallback if no other conditions above are met

            "Until" phrasing logic:
            "[empty]": if the start date and end date of the instance are identical, and/or if an end time is not defined
            "until [date]": if the instance start date is not the same as the end date (and the end time is not defined), and a 'start_date' constant is not defined
            "until [date], [time]": if the instance start date is not the same as the end date (and the end time is defined), and a 'start_date' constant is not defined
            "until [time]": if the instance start date is the same as the end date (and the end time is defined), and a 'start_date' constant is not defined

            Note that "until" logic doesn't need to account for "23:59" end times here because these times are (generally) only assigned
            via map_event_range(), which is not used on querysets for non-date-based views (not used on views where start_date is not set.)
            {% endcomment %}

            <time class="dtstart" datetime="{{ instance_start|date:"cZ" }}">
                {% if not start_date %}
                    <span class="start-date">{{ instance_start.date }}</span>
                {% endif %}
                {% if instance_start.time %}
                    <span class="start-time">
                        {% if not start_date %}
                        at
                        {% endif %}
                        {{ instance_start|date:"f a" }}
                    </span>
                {% elif not instance_start.time and not instance_end.time and instance_start == instance_end %}
                {% elif instance_start|date:"H:i" == "00:00" and instance_end|date:"H:i" == "23:59" %}
                    <span class="start-time">All Day</span>
                {% elif instance_start|date:"H:i" == "00:00" and instance_end|date:"H:i" != "23:59" %}
                    <span class="until">until {{ instance_end|date:"f a" }}</span>
                {% else %}
                    <span class="start-time">All Day</span>
                {% endif %}
                <span class="value-title" title="{{ instance_start|date:"cZ" }}"></span>
            </time>
            {% if not start_date %}
            <time class="dtend" datetime="{{ instance_end|date:"cZ" }}">
                {% if instance.object %}
                    {% with last_instance=instance.object.get_last_instance %}
                        {% if instance_start == last_instance.end %}
                        {% elif last_instance.end.date != instance_start.date %}
                            until {{ last_instance.end|date:"N j, Y" }}{% if last_instance.end.time %}, {{ last_instance.end.time }}{% endif %}
                        {% elif last_instance.end.time %}
                            until {{ last_instance.end.time }}
                        {% endif %}
                    {% endwith %}
                {% else %}
                    {% if instance_start == instance_end %}
                    {% elif instance_end.date != instance_start.date %}
                        until {{ instance_end|date:"N j, Y" }}{% if instance_end.time %}, {{ instance_end.time }}{% endif %}
                    {% elif instance_end.time %}
                        until {{ instance_end.time }}
                    {% endif %}
                {% endif %}
            </time>
            {% endif %}

            <span class="location h4 alt">{% include_esi 'location' object.location.pk 'comboname' %}</span>
            <p class="description">
                {{ object.event.description|striptags|truncatewords:60 }}
            </p>
            {% if not calendar %}
            <span class="calendar">
                <i class="fa fa-calendar"></i> {% include_esi 'calendar' object.event.calendar.pk 'title' %}
            </span>
            {% endif %}

            <a class="event-content url" href="{% url 'event' pk=object.pk slug=object.slug %}">
                <span class="sr-only">View Event</span>
            </a>
        </li>
    {% endwith %}
{% endwith %}