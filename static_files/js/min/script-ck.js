var bulkSelectAll=function(){$("#bulk-select-all").click(function(){var e=$(this),t=$(".field-bulk-select input");t.prop("checked",e.is(":checked"))})},bulkActionSubmit=function(){var e=$("#bulk-action_0, #bulk-action_1");e.removeAttr("onchange"),$("#bulk-action_0, #bulk-action_1").change(function(){var e=this.form;actionInput=$(this),actionInputValue=actionInput.find("option:selected"),eventsSelected=$('input:checkbox:checked[name="object_ids"]'),recurringEvents=!1,actionInputValue.attr("value")&&eventsSelected.length&&("delete"==actionInputValue.val()?(eventsSelected.each(function(e,t){var a=$(this);return parseInt(a.attr("data-event-instance-count"))>1?(recurringEvents=!0,!1):void 0}),recurringEvents?(bulkEventDeleteModal=$("#bulk-event-delete-modal"),bulkEventDeleteModal.find("#bulk-event-delete-btn").click(function(){e.submit()}),bulkEventDeleteModal.modal()):e.submit()):e.submit())})},autoOpenTagByAnchor=function(){var e=window.location.hash.substring(1),t=$('.nav-tabs li a[href="#'+e+'"]').parent("li"),a=$("#"+e);null!==e&&a.length>0&&a.hasClass("tab-pane")&&($(".nav-tabs li.active, .tab-pane.active").removeClass("active"),t.addClass("active"),a.addClass("active"))},toggleModalModifyObject=function(){$(".object-modify").click(function(e){e.preventDefault();var t=$(this),a=t.attr("href"),n=$("#object-modify-modal");n?$.ajax({url:a,timeout:600}).done(function(e){var t=$("<div />");t.html(e);var i="",l="",o="";t.find(".object-modify-form").length>0?(i=t.find("h1").html(),l=t.find(".modal-body-content").html(),o=t.find(".modal-footer-content").html()):(i="Error",l="<p>You do not have access to this content.</p>",o='<a class="btn" data-dismiss="modal" href="#">Close</a>'),n.find("h2").html(i).end().find("form").attr("action",a).end().find(".modal-body").html(l).end().find(".modal-footer").html(o).end().modal("show")}).fail(function(){window.location=a}):window.location=a})},toggleModalMergeObject=function(){var e=$("#object-merge-modal");$(".category-merge, .tag-merge, .location-merge").click(function(t){t.preventDefault();var a=$(this).attr("data-object-title"),n=$(this).attr("href"),i="";i=$(this).hasClass("category-merge")?"category":"tag",e.find("#new-object-select option").each(function(){$(this).text()==a?$(this).prop("disabled",!0):$(this).prop("disabled",!1)}),e.find("span.object-type").text(i).end().find("h2 span.alt").text(a).end().find(".modal-footer a.btn-primary").attr("href",n).end().modal("show")});var t=e.find(".modal-footer a.btn:first-child");t.click(function(){var e=$("#new-object-select").val(),a=t.attr("href");""!==e&&(a=a.replace(/merge\/[A-Za-z0-9]+$/,"merge/"+e),t.attr("href",a))})},calendarSliders=function(){$("body").on("click",".calendar-slider ul.pager li a",function(e){e.preventDefault();var t=$(this).parents(".calendar-slider");$.get($(this).attr("data-ajax-link"),function(e){t.replaceWith(e)})})},inputTypeSupport=function(e){var t=document.createElement("input");return t.setAttribute("type",e),t.type==e?!0:!1},initiateDatePickers=function(e){e.each(function(){var e=$(this);e.parent().hasClass("bootstrap-datepicker")===!1&&e.wrap('<div class="bootstrap-datepicker" />').parent().append('<i class="icon-calendar" />');var t=e.parent().parent(),a=t.siblings().find("."+e.attr("class"));e.datepicker({format:"mm/dd/yyyy",autoclose:!0,todayHighlight:!0}).on("changeDate",function(e){a.length&&t.hasClass("start")?a.datepicker("setStartDate",e.date):a.length&&t.hasClass("end")&&a.datepicker("setEndDate",e.date)})})},initiateTimePickers=function(e){e.each(function(){$(this).parent().hasClass("bootstrap-timepicker")===!1&&$(this).wrap('<div class="bootstrap-timepicker" />').parent().append('<i class="icon-time" />')}).timepicker({scrollDefaultNow:!0,timeFormat:"h:i A",step:15})},initiateWysiwyg=function(e){e.wysihtml5({"font-styles":!0,emphasis:!0,lists:!0,html:!1,link:!0,image:!1,color:!1,events:{load:function(){$("ul.wysihtml5-toolbar").find('li a[data-wysihtml5-command="createLink"]').html('<i class="icon-link"></i>').end().find("li.dropdown a").attr("tabindex","-1")}}})},initiateDisabledWysiwyg=function(e){e.wysihtml5({"font-styles":!1,emphasis:!1,lists:!1,html:!1,link:!1,image:!1,color:!1})},initiateReReviewCopy=function(){$("#copy_title").click(function(e){e.preventDefault(),$("#"+$(this).attr("data-copy-to")).val($("#new_title").val())}),$("#copy_description").click(function(e){e.preventDefault(),$("#"+$(this).attr("data-copy-to")).data("wysihtml5").editor.setValue($("#new_description").val())})},userSearchTypeahead=function(){var e=$("#id_add_user"),t=$("#id_username_d"),a=$("#id_username"),n=[],i={},l=null;t.hide(),e.show(),$('label[for="id_username"]').attr("for",e.attr("name"));var o=function(){var e=[];return $('.calendar-access-username:not("th")').each(function(){e.push($(this).html())}),e};e.typeahead({source:function(e,a){var l=l();$.each(t.children("option"),function(){var e=$(this),t=e.val(),a=e.text();a=$.trim(a).length<1?t+" (name n/a)":a+" ("+t+")",!l.indexOf(t)>-1&&(i[a]=t,n.push(a))}),a(n)},items:10,minLength:2,updater:function(e){return l=i[e],e}})},userAddValidation=function(){var e=$("#add-user-submit"),t=function(e){e.preventDefault()},a=function(){""===$("#id_add_user").val()||""===$("#id_username").val()||""===$("#id_role").val()?e.addClass("disabled").bind("click",t):e.removeClass("disabled").unbind("click",t)};a(),$("#id_add_user, #id_username, #id_role").on("change",function(){a()}),e.click(function(e){if($(this).hasClass("disabled")===!1){var t=$("#manager-calendar-add-user"),a=t.attr("action"),n=$("#id_username").val(),i=$("#id_add_role").val();a=a.replace("/username/role","/"+n+"/"+i),t.attr("action",a)}})},cloneableFieldsets=function(){if($(".cloneable").length>0){var e=$(".cloneable").parent(),t=e.children(":first"),a=e.parent().find(".cloner"),n=t.attr("data-form-prefix"),i=function(e,t,a){var n=new RegExp("("+t+"-\\d+-)"),i=t+"-"+a+"-";$(e).attr("for")&&$(e).attr("for",$(e).attr("for").replace(n,i)),e.id&&(e.id=e.id.replace(n,i)),e.name&&(e.name=e.name.replace(n,i))},l=function(t){1==$("#id_"+t+"-TOTAL_FORMS").val()?e.find(".remove-instance").addClass("hidden"):e.find(".remove-instance").removeClass("hidden")},o=function(e,t){var a=parseInt($("#id_"+t+"-TOTAL_FORMS").val(),10);return a>1&&($(e).parents(".cloneable").slideUp(300).find('input[id*="-DELETE"]').prop("checked",!0),setTimeout(function(){""==$(e).parents(".cloneable").find('input[id$="-id"]').val()&&$(e).parents(".cloneable").remove();var n=$(".cloneable");$("#id_"+t+"-TOTAL_FORMS").val(n.length);var o=0;for(a=n.length;a>o;o++)$(n.get(o)).find("input, textarea, select, label").each(function(){i(this,t,o)});l(t)},300)),!1},r=function(e,a){var n=parseInt($("#id_"+a+"-TOTAL_FORMS").val(),10);if(n<$("#id_"+a+"-MAX_NUM_FORMS").val()){var r=t.clone(!1).get(0);$(r).removeAttr("id").addClass("clone").hide().insertAfter(".cloneable:last").slideDown(300).find("input, textarea, select, label").each(function(){i(this,a,n);var e=$(this);e.is("select")?e.attr("id").indexOf("interval")>=0&&e.find("option:first").attr("selected","selected"):e.val("")}),$(r).find(".remove-instance").click(function(){return o(this,a)}),initiateDatePickers($(r).find(".field-date")),initiateTimePickers($(r).find(".field-time")),eventLocationsSearch($(r).find(".location-dropdown")),$("#id_"+a+"-TOTAL_FORMS").val(n+1),l(a)}else alert("Sorry, you can only create a maximum of twelve time/locations.");return!1};l(n),a.click(function(e){return e.preventDefault(),r(this,n)}),$(".remove-instance").click(function(e){return e.preventDefault(),o(this,n)})}},calendarOwnershipModal=function(){if($("#calendar-reassign-ownership")){var e=$("#calendar-reassign-ownership"),t=e.find(".modal-footer a.btn:first-child");t.click(function(){var e=$("#new-owner-select").val(),a=t.attr("href");""!==e&&(a=a.replace(/user\/[A-Za-z0-9]+$/,"user/"+e),t.attr("href",a))})}},calendarSubscribeModal=function(){if($("#calendar-subscribe-modal")){var e=$("#calendar-subscribe-modal"),t=e.find(".modal-footer a.btn:first-child");$(".calendar-subscribe").click(function(t){t.preventDefault(),e.modal("show")}),t.click(function(){var e=$("#new-subscription-select").val(),a=t.attr("href");""!==e&&(a=a.replace(/calendar\/[A-Za-z0-9-]+\/subscribe/,"calendar/"+e+"/subscribe"),t.attr("href",a))})}},toggleEventListRecurrences=function(){$(".recurrences-toggle").click(function(e){e.preventDefault(),$(this).next(".recurrences").slideToggle()})},eventLocationsSearch=function(e){e.length>0&&e.each(function(){var e=$(this),t=e.attr("id")+"-autocomplete",a=e.parents(".cloneable"),n=a.parents(".control-group").find(".cloner"),i=e.parent(".location-search").parent(".row"),l=i.find(".location-selected-title"),o=i.find(".location-selected-room"),r=i.find(".location-selected-url"),c=i.find(".location-new-form");e.hide(),c.children('input[name*="-new_location_title"]').val()||c.hide(),n.html('<div>Add another event instance...</div><a class="btn btn-success" href="#" alt="Add another event instance" title="Add another event instance"><i class="icon-plus"></i></a>');var s=null,d=null,u=null,f=null;e.siblings(".location-autocomplete").length<1?(s=$('<input type="text" id="'+t+'" class="location-autocomplete search-query" autocomplete="off" placeholder="Type a location name..." />'),s.insertAfter(e),d=$('<a class="autocomplete-new-btn btn btn-success" href="#" alt="Create New Location"><i class="icon-plus"></i></a>'),d.insertAfter(s).hide(),u=$('<ul class="dropdown-menu location-suggestions autocomplete-suggestion-list"></ul>'),u.insertAfter(d).hide(),f=$('<a class="location-selected-remove" href="#" alt="Remove Location" title="Remove Location">&times;</a>'),f.insertBefore(l)):(s=e.siblings(".location-autocomplete"),d=e.siblings(".autocomplete-new-btn"),u=e.siblings(".location-suggestions"),f=i.find(".location-selected-remove")),e.siblings('label[for*="-location"]').attr("for",t),""==e.val()&&""==$.trim(l.text())&&f.hide();var h=function(e){var t=!1,a=[],n=0;$.each(eventLocations,function(i,l){if(l.comboname.toLowerCase().indexOf(e.toLowerCase())>-1){t=!0;var o=$('<li data-location-id="'+i+'" data-location-title="'+l.title+'" data-location-room="'+l.room+'" data-location-url="'+l.url+'"></li>'),r=$('<a tabindex="0" class="suggestion-link" href="#">'+l.comboname+"</a>");if(r.on("click",function(e){e.preventDefault(),m(o)}),o.html(r),a.push(o),n++,10==n)return!1}}),1==t?($.each(a,function(e,t){t.appendTo(u)}),u.show()):(u.hide(),d.show())};e.parents("form").on("submit",function(e){return $(".location-autocomplete").is(":focus")?!1:void 0});var p=null,v=300;s.on("keyup focus",function(e){clearTimeout(p);var t=s.val().replace(/([^a-zA-Z0-9\s-!$#%&+|:?])/g,"");if(""!==t){if("focus"==e.type||"keyup"==e.type&&8!==e.keyCode&&e.keyCode>44)p=setTimeout(function(){u.empty(),h(t)},v);else if("keyup"==e.type&&e.keyCode>36&&e.keyCode<41){if(u.children().length>0){var a=u.children(".selected"),n=null;if(40==e.keyCode)n=a.length>0&&0!==a.next("li").length?a.next("li"):u.children("li").first();else if(38==e.keyCode)n=a.length>0&&0!==a.prev("li").length?a.prev("li"):u.children("li").last();else if(39==e.keyCode||37==e.keyCode)return;a.removeClass("selected"),n.addClass("selected"),s.val(n.attr("data-location-title"))}}else if("keyup"==e.type&&13==e.keyCode)if(u.children().length>0){var a=u.children(".selected");m(a.length<1?u.children("li").first():a.first())}else b()}else u.empty().hide()});var m=function(t){g(),y(f),l.text(t.attr("data-location-title")).show(),o.text(t.attr("data-location-room")).show(),r.html('<a href="'+t.attr("data-location-url")+'"><i class="icon-external-link"></i> '+t.attr("data-location-url")+"</a>").show(),u.empty().hide(),e.children('option[selected="selected"]').attr("selected",!1).end().children('option[value="'+t.attr("data-location-id")+'"]').attr("selected",!0),e.get(0).selectedIndex=e.children('option[value="'+t.attr("data-location-id")+'"]').val(),f.show(),s.val("")},g=function(){l.text("").hide(),o.text("").hide(),r.text("").hide(),e.children('option[selected="selected"]').attr("selected",!1).end().children('option[value=""]').attr("selected",!0),f.hide()},b=function(){g(),y(),c.show().children('input[name*="-new_location_title"]').val(s.val()),f.show(),u.empty().hide(),d.hide(),s.val("")},y=function(){c.hide().children("input").val(""),f.hide()};f.on("click",function(e){e.preventDefault(),g(),y()}),d.on("click",function(e){e.preventDefault(),b()}),a.hasClass("clone")&&(e.get(0).selectedIndex=e.children('option[selected="selected"]').val())})};eventTagging=function(){if($("#id_event-tags").length>0){var e=$("#id_event-tags");e.hide();var t=e.val();if(""!==t){for(var a=t.split(","),n=0;n<a.length;n++)a[n]=a[n].trim(),'"'!==a[n].charAt(0)&&(a[n]='"'+a[n]+'"');a=a.join(","),e.val(a).attr("value",a)}var i=e.siblings(".help-text");i.text('Type a word or phrase, then hit the "enter" key or type a comma to add it to your list of tags.');var l=$('<input type="text" id="id_event-tags-autocomplete" autocomplete="off" placeholder="Type a tag or phrase..." />'),o=$('<ul class="dropdown-menu autocomplete-suggestion-list" id="id_event-tags-suggestions"></ul>'),r=$("#event-tags-selected");if(l.insertAfter(e),o.insertAfter(i),tagNewBtn=$('<a class="autocomplete-new-btn btn btn-success" href="#" alt="Create New Tag"><i class="icon-plus"></i></a>'),tagNewBtn.insertAfter(l).hide(),""!==e.val()&&r.children().length<1){var c=e.val().replace(/\"/g,"").split(",").filter(Boolean);$.each(c,function(e,t){r.append('<li data-tag-name="'+t+'"><a href="#" class="selected-remove" alt="Remove this tag">&times;</a>'+t+"</li>")})}var s=function(e){for(var t=!1,a=[],n=0,i=0;i<eventTags.length;i++){var l=eventTags[i];if(l.toLowerCase().indexOf(e.toLowerCase())>-1){t=!0;var r=$('<li data-tag-name="'+l+'"></li>'),c=$('<a tabindex="0" class="suggestion-link" href="#">'+l+"</a>");if(c.on("click",function(e){e.preventDefault(),f($(this).parent("li"))}),r.html(c),a.push(r),n++,10==n)return!1}}1==t?($.each(a,function(e,t){t.appendTo(o)}),o.show()):(o.hide(),tagNewBtn.show())};e.parents("form").on("submit",function(e){return l.is(":focus")?!1:void 0});var d=null,u=300;l.on("keyup focus",function(e){clearTimeout(d);var t=l.val().replace(/([^a-zA-Z0-9\s-!$#%&+|:?])/g,"");if(""!==t)if("focus"==e.type||"keyup"==e.type&&8!==e.keyCode&&e.keyCode>44&&188!==e.keyCode)d=setTimeout(function(){o.empty(),s(t)},u);else if("keyup"==e.type&&e.keyCode>36&&e.keyCode<41){if(o.children().length>0){var a=o.children(".selected"),n=null;if(40==e.keyCode)n=a.length>0&&0!==a.next("li").length?a.next("li"):o.children("li").first();else if(38==e.keyCode)n=a.length>0&&0!==a.prev("li").length?a.prev("li"):o.children("li").last();else if(39==e.keyCode||37==e.keyCode)return;a.removeClass("selected"),n.addClass("selected"),l.val(n.attr("data-tag-name"))}}else"keyup"!=e.type||13!=e.keyCode&&188!=e.keyCode||f($('<li data-tag-name="'+t+'"><a tabindex="0" class="suggestion-link" href="#">'+t+"</a></li>"));else o.empty().hide()});var f=function(t){var a=$('<a href="#" class="selected-remove" alt="Remove this tag" title="Remove this tag">&times;</a>');a.on("click",function(e){e.preventDefault(),h($(this).parent("li"))});var n=t.attr("data-tag-name");t.appendTo(r).prepend(a),o.empty().hide(),t.find(".suggestion-link").replaceWith(n),e.val(e.val()+'"'+n+'",'),l.val(""),tagNewBtn.hide()},h=function(t){r.find(t).remove();var a="";a=e.val().indexOf('"'+t.attr("data-tag-name")+'",')>-1?e.val().replace('"'+t.attr("data-tag-name")+'",',""):e.val().replace('"'+t.attr("data-tag-name")+'"',""),e.val(a).attr(a)};$(".selected-remove").on("click",function(e){e.preventDefault(),h($(this).parent("li"))}),tagNewBtn.on("click",function(e){e.preventDefault();var t=l.val().replace(/([^a-zA-Z0-9\s-!$#%&+|:?])/g,"");f($('<li data-tag-name="'+t+'"><a tabindex="0" class="suggestion-link" href="#">'+t+"</a></li>"))})}};var toggleModalUserDemote=function(){var e=$("#user-demote-modal");$(".demote-self").click(function(t){t.preventDefault();var a=$(this).attr("data-user-name"),n=$(this).attr("href");e.find("h2 span.alt").text(a).end().find(".modal-footer a.btn-danger").attr("href",n).end().modal("show")});var t=e.find(".modal-footer a.btn:first-child");t.click(function(){var e=$("#new-object-select").val(),a=t.attr("href");""!==e&&(a=a.replace(/merge\/[A-Za-z0-9]+$/,"merge/"+e),t.attr("href",a))})},updateMonthviewDropdown=function(){var e=$("#month-toggle"),t=e.find("#id_year"),a=e.find("#id_month");a.change(function(){var t=e.attr("action"),a="/"+$(this).val()+"/",n=t.slice(t.length-4,t.length),i=t.replace(n,a);e.attr("action",i)}),t.change(function(){var t=e.attr("action"),a="/"+$(this).val()+"/",n=t.slice(t.length-9,t.length-3),i=t.replace(n,a);e.attr("action",i)})},eventContactInfo=function(){$("#add-user-contact-info").click(function(e){var t=$(this);e.preventDefault(),usersFullName&&usersEmail&&($("#id_event-contact_name").val(usersFullName),$("#id_event-contact_email").val(usersEmail))})};$(document).ready(function(){bulkSelectAll(),bulkActionSubmit(),autoOpenTagByAnchor(),toggleModalModifyObject(),toggleModalMergeObject(),toggleModalUserDemote(),calendarSliders(),initiateDatePickers($(".field-date")),initiateTimePickers($(".field-time")),initiateWysiwyg($('textarea.wysiwyg:not(".disabled-wysiwyg")')),initiateDisabledWysiwyg($("textarea.wysiwyg.disabled-wysiwyg")),initiateReReviewCopy(),userSearchTypeahead(),userAddValidation(),cloneableFieldsets(),calendarOwnershipModal(),calendarSubscribeModal(),toggleEventListRecurrences(),eventLocationsSearch($("select.location-dropdown")),eventTagging(),updateMonthviewDropdown(),eventContactInfo()});